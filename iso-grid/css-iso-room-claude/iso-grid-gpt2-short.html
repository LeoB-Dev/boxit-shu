<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Isometric Drag</title>
    <style>
        body {
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: #0f172a
        }

        svg {
            background: #020617;
            border: 2px solid #334155;
            touch-action: none
        }

        .tile {
            stroke: #334155;
            fill: none;
            stroke-width: 2
        }

        .item {
            stroke: #020617;
            stroke-width: 2;
            cursor: grab
        }

        .ghost {
            opacity: .75;
            pointer-events: none
                /* EXPLANATION: */
        }

        .preview {
            stroke-dasharray: 6 6;
            /* EXPLANATION: What's the difference between preview and ghost */
            fill-opacity: .35;
            pointer-events: none
        }
    </style>
</head>

<body>
    <svg id="s" width="800" height="600"></svg> <!--EXPLAIN: -->
    <script>
        const W = 64, H = 32, G = 8, GO = { x: 400, y: 120 }, TO = { x: 400, y: 440 }, svg = s /* EXPLANATION: */

        let items = [
            { id: 1, x: 0, y: 0, w: 1, h: 1, c: "#3b82f6", t: 1 },
            { id: 2, x: 2, y: 0, w: 2, h: 1, c: "#ef4444", t: 1 },
            { id: 3, x: 4, y: 0, w: 1, h: 2, c: "#10b981", t: 1 }
        ] /* EXPLANATION: */

        let drag = null, ghost, preview /* EXPLANATION: */

        const iso = (x, y, o) => ({ x: (x - y) * W / 2 + o.x, y: (x + y) * H / 2 + o.y })
        const inv = (x, y, o) => ({ x: ((x - o.x) / (W / 2) + (y - o.y) / (H / 2)) / 2, y: ((y - o.y) / (H / 2) - (x - o.x) / (W / 2)) / 2 })
        const snap = (p, i) => ({ x: Math.max(0, Math.min(G - i.w, Math.round(p.x - i.w / 2))), y: Math.max(0, Math.min(G - i.h, Math.round(p.y - i.h / 2))) })
        const inside = (x, y) => { const p = inv(x, y, GO); return p.x >= 0 && p.y >= 0 && p.x <= G && p.y <= G }

        const poly = (x, y, w, h, o) => {
            const a = iso(x, y, o), b = iso(x + w, y, o), c = iso(x + w, y + h, o), d = iso(x, y + h, o)
            return `${a.x},${a.y} ${b.x},${b.y} ${c.x},${c.y} ${d.x},${d.y}`
        }

        const make = (cls, fill) => {
            const p = document.createElementNS("http://www.w3.org/2000/svg", "polygon")
            p.setAttribute("class", cls); if (fill) p.setAttribute("fill", fill)
            svg.appendChild(p); return p
        }

        /* grid */
        for (let y = 0; y < G; y++)for (let x = 0; x < G; x++)make("tile").setAttribute("points", poly(x, y, 1, 1, GO))
        for (let i = 0; i < 6; i++)make("tile").setAttribute("points", poly(i, 0, 1, 1, TO))

        function draw() {
            document.querySelectorAll(".item").forEach(e => e.remove())
            items.forEach(it => {
                if (drag && drag.it.id === it.id) return
                const o = it.t ? TO : GO
                const p = make("item", it.c)
                p.setAttribute("points", poly(it.x, it.y, it.w, it.h, o))
                p.onpointerdown = e => start(e, it)
            })
        }

        draw()

        function start(e, it) {
            const r = svg.getBoundingClientRect(), x = e.clientX - r.left, y = e.clientY - r.top
            const o = it.t ? TO : GO, tl = iso(it.x, it.y, o)
            drag = { it, dx: x - tl.x, dy: y - tl.y }
            ghost = make("item ghost", it.c)
            preview = make("item preview", it.c)
            svg.setPointerCapture(e.pointerId)
            move(e)
        }

        function move(e) {
            if (!drag) return
            const r = svg.getBoundingClientRect(), mx = e.clientX - r.left, my = e.clientY - r.top
            const px = mx - drag.dx, py = my - drag.dy
            const o = drag.it.t ? TO : GO, isoPos = inv(px, py, o)

            ghost.setAttribute("points", poly(isoPos.x, isoPos.y, drag.it.w, drag.it.h, o))

            if (inside(mx, my)) {
                const p = snap(inv(mx, my, GO), drag.it)
                preview.setAttribute("points", poly(p.x, p.y, drag.it.w, drag.it.h, GO))
                preview.style.display = "block"
            } else preview.style.display = "none"
        }

        function end(e) {
            if (!drag) return
            const r = svg.getBoundingClientRect(), mx = e.clientX - r.left, my = e.clientY - r.top
            if (inside(mx, my)) {
                const p = snap(inv(mx, my, GO), drag.it)
                drag.it.x = p.x; drag.it.y = p.y; drag.it.t = 0
            }
            ghost.remove(); preview.remove(); drag = null; draw()
        }

        svg.onpointermove = move
        svg.onpointerup = e => { svg.releasePointerCapture(e.pointerId); end(e) }
        svg.onpointercancel = e => { svg.releasePointerCapture(e.pointerId); end(e) }
    </script>
</body>

</html>